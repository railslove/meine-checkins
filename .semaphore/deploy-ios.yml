version: v1.0
name: Deploy iOS
agent:
  machine:
    type: a1-standard-4
    os_image: macos-xcode12

blocks:
  - name: Install
    dependencies: []
    task:
      jobs:
        - name: npm install
          commands:
            - checkout --use-cache
            - cache restore
            - npm i
            - cache store
        - name: bundle install
          commands:
            - checkout --use-cache
            - cache restore
            - bundle install --path vendor/bundler
            - cache store

  - name: Build iOS and deploy to Testflight
    dependencies:
      - Install
    task:
      env_vars:
        - name: LANG
          value: en_US.UTF-8
        - name: ENVFILE
          value: '.env.production'
      secrets:
        - name: wfd-masterapp-app-secrets
      prologue:
        commands:
          - checkout --use-cache
          - cache restore
          # Needs ssh to clone apple-credentials repo for fastlane match
          - chmod 600 ~/.ssh/apple_certificates_deploy_rsa
          - ssh-add ~/.ssh/apple_certificates_deploy_rsa
      jobs:
        - name: fastlane ios deploy
          commands:
            - fastlane ios deploy
